<svg width="800" height="320" viewBox="0 0 800 320" xmlns="http://www.w3.org/2000/svg" font-family="'Segoe UI',system-ui,sans-serif">
  <defs>
    <style>
      @keyframes dash { to { stroke-dashoffset: -20; } }
      .arrow { animation: dash 1.4s linear infinite; }
    </style>
    <linearGradient id="bg2" x1="0" y1="0" x2="1" y2="1" gradientUnits="objectBoundingBox">
      <stop offset="0%" stop-color="#f0f4ff"/>
      <stop offset="100%" stop-color="#f8fafc"/>
    </linearGradient>
    <marker id="arrowB" markerWidth="8" markerHeight="8" refX="6" refY="3" orient="auto">
      <path d="M0,0 L0,6 L8,3 z" fill="#4f8ef7"/>
    </marker>
    <marker id="arrowR" markerWidth="8" markerHeight="8" refX="6" refY="3" orient="auto">
      <path d="M0,0 L0,6 L8,3 z" fill="#e74c3c"/>
    </marker>
    <marker id="arrowG" markerWidth="8" markerHeight="8" refX="6" refY="3" orient="auto">
      <path d="M0,0 L0,6 L8,3 z" fill="#27ae60"/>
    </marker>
    <filter id="sh2">
      <feDropShadow dx="0" dy="2" stdDeviation="3" flood-color="#00000018"/>
    </filter>
  </defs>

  <rect width="800" height="320" fill="url(#bg2)"/>

  <!-- Title -->
  <text x="400" y="26" text-anchor="middle" fill="#1e293b" font-size="14" font-weight="700">UDP Truncation: When DNS Sends an Incomplete Answer</text>

  <!-- ── Client box (left) ── -->
  <rect x="30" y="80" width="120" height="60" rx="10" fill="white" stroke="#4f8ef7" stroke-width="2" filter="url(#sh2)"/>
  <text x="90" y="106" text-anchor="middle" fill="#4f8ef7" font-size="11" font-weight="700">Client</text>
  <text x="90" y="120" text-anchor="middle" fill="#64748b" font-size="9">stub resolver</text>

  <!-- ── DNS Server box (center) ── -->
  <rect x="330" y="60" width="140" height="100" rx="10" fill="white" stroke="#4f8ef7" stroke-width="2" filter="url(#sh2)"/>
  <text x="400" y="95" text-anchor="middle" fill="#1e293b" font-size="11" font-weight="700">DNS Server</text>
  <text x="400" y="111" text-anchor="middle" fill="#64748b" font-size="9">has 14 A records</text>
  <text x="400" y="125" text-anchor="middle" fill="#64748b" font-size="9">response: ~1.8 KB</text>
  <text x="400" y="139" text-anchor="middle" fill="#e74c3c" font-size="9" font-weight="600">exceeds 512B limit</text>

  <!-- ── Query arrow (left to center) ── -->
  <line x1="152" y1="105" x2="328" y2="105" stroke="#4f8ef7" stroke-width="1.8" stroke-dasharray="5 3" class="arrow" marker-end="url(#arrowB)"/>
  <text x="240" y="98" text-anchor="middle" fill="#4f8ef7" font-size="9">query: api.internal (UDP)</text>

  <!-- ── Truncated response arrow (center to left, offset down) ── -->
  <line x1="328" y1="135" x2="152" y2="135" stroke="#e74c3c" stroke-width="2" stroke-dasharray="5 3" class="arrow" marker-end="url(#arrowR)"/>
  <text x="240" y="128" text-anchor="middle" fill="#e74c3c" font-size="9">response (UDP) — TC=1</text>


  <!-- ── Partial records received ── -->
  <rect x="30" y="170" width="120" height="70" rx="8" fill="#fff8f8" stroke="#e74c3c" stroke-width="1.5" filter="url(#sh2)"/>
  <text x="90" y="190" text-anchor="middle" fill="#c0392b" font-size="10" font-weight="700">Received 6/14</text>
  <text x="90" y="204" text-anchor="middle" fill="#64748b" font-size="8.5">10.0.1.1</text>
  <text x="90" y="216" text-anchor="middle" fill="#64748b" font-size="8.5">10.0.1.2 … 10.0.1.6</text>
  <text x="90" y="228" text-anchor="middle" fill="#e74c3c" font-size="8.5" font-weight="600">8 records missing</text>

  <!-- ── Divider ── -->
  <line x1="490" y1="50" x2="490" y2="290" stroke="#e2e8f0" stroke-width="1.5" stroke-dasharray="4 4"/>
  <text x="493" y="48" fill="#94a3b8" font-size="9">what happens next</text>

  <!-- ── Fork connector: branch from divider to Path A (up) and Path B (down) ── -->
  <!-- Horizontal stub out from divider -->
  <line x1="490" y1="160" x2="506" y2="160" stroke="#94a3b8" stroke-width="1.5"/>
  <!-- Vertical spine connecting the two branches -->
  <line x1="506" y1="106" x2="506" y2="228" stroke="#94a3b8" stroke-width="1.5"/>
  <!-- Arrow to Path A (green) -->
  <line x1="506" y1="106" x2="511" y2="106" stroke="#27ae60" stroke-width="1.8" marker-end="url(#arrowG)"/>
  <!-- Arrow to Path B (red) -->
  <line x1="506" y1="228" x2="511" y2="228" stroke="#e74c3c" stroke-width="1.8" marker-end="url(#arrowR)"/>

  <!-- ── Path A: well-behaved (retries TCP) ── -->
  <rect x="512" y="60" width="260" height="92" rx="10" fill="#f0fff4" stroke="#27ae60" stroke-width="2" filter="url(#sh2)"/>
  <!-- Green ✓ badge -->
  <circle cx="530" cy="80" r="10" fill="#27ae60"/>
  <text x="530" y="84" text-anchor="middle" fill="white" font-size="12" font-weight="700">✓</text>
  <text x="655" y="82" text-anchor="middle" fill="#166534" font-size="11" font-weight="700">Path A — Good resolver</text>
  <text x="642" y="98" text-anchor="middle" fill="#374151" font-size="9">Sees TC=1 flag → retries query over TCP</text>
  <text x="642" y="112" text-anchor="middle" fill="#374151" font-size="9">Gets all 14 A records</text>
  <text x="642" y="126" text-anchor="middle" fill="#166534" font-size="9" font-weight="600">Traffic balanced correctly across all backends</text>

  <!-- ── Path B: bad/silent truncation ── -->
  <rect x="512" y="178" width="260" height="100" rx="10" fill="#fff0f0" stroke="#e74c3c" stroke-width="2" filter="url(#sh2)"/>
  <!-- Red ✗ badge -->
  <circle cx="530" cy="198" r="10" fill="#e74c3c"/>
  <text x="530" y="202" text-anchor="middle" fill="white" font-size="12" font-weight="700">✗</text>
  <text x="655" y="200" text-anchor="middle" fill="#c0392b" font-size="11" font-weight="700">Path B — Silent truncation</text>
  <text x="642" y="216" text-anchor="middle" fill="#374151" font-size="9">Ignores TC=1 — uses partial 6-record answer</text>
  <text x="642" y="230" text-anchor="middle" fill="#374151" font-size="9">8 backends receive zero traffic</text>
  <text x="642" y="244" text-anchor="middle" fill="#c0392b" font-size="9" font-weight="600">Looks like a load-balancer bug.</text>
  <text x="642" y="258" text-anchor="middle" fill="#c0392b" font-size="9" font-weight="600">It's DNS.</text>

  <!-- Bottom note -->
  <text x="400" y="305" text-anchor="middle" fill="#94a3b8" font-size="9" font-style="italic">EDNS0 raises the UDP ceiling to 4096B — but silent truncation still happens when responses exceed it.</text>
</svg>
